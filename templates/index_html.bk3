<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Host Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        .container-fluid { max-width: 98%; }
        .card-custom { background: #2d2d2d; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 20px; padding: 20px; }
        .kpi-card { text-align: center; padding: 12px; border-radius: 8px; background: #333; border: 1px solid #444; margin-bottom: 10px; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; color: #fff; }
        .kpi-label { font-size: 0.8rem; color: #ccc; text-transform: uppercase; letter-spacing: 1px; }
        .chart-title { color: #e0e0e0; text-align: center; margin-bottom: 15px; font-weight: 600; font-size: 1.1rem; }
        #last-updated { color: #e0e0e0; opacity: 0.8; font-size: 0.9rem; }
        .filename-link { color: #0dcaf0; font-weight: bold; font-family: monospace; text-decoration: none; transition: color 0.2s; }
        .filename-link:hover { color: #3dd5f3; text-decoration: underline; }
        table.dataTable tbody tr { background-color: #2d2d2d; color: #e0e0e0; }
        table.dataTable tbody tr:hover { background-color: #383838; }
        .table-striped>tbody>tr:nth-of-type(odd)>* { box-shadow: none; color: #e0e0e0; background-color: #333; }
        .table { color: #e0e0e0; border-color: #404040; }
        .badge-online { background-color: #198754; color: white; padding: 5px 10px; border-radius: 4px; }
        .badge-offline { background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; }
        .badge-boneyard { background-color: #6c757d; color: white; padding: 5px 10px; border-radius: 4px; }
        .header_row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-galactic { background-color: #0d6efd; border: none; color: white; font-weight: 500; transition: all 0.3s; }
        .btn-galactic:hover { background-color: #0b5ed7; box-shadow: 0 0 10px rgba(13, 110, 253, 0.5); }
        .btn-galactic:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; }
        .subtitle { color: #b0b0b0; font-size: 0.95rem; margin-top: 4px; display: flex; align-items: center; gap: 8px; }
        .chart-container { position: relative; height: 220px; width: 100%; }
        #file-select { background-color: #333; color: #e0e0e0; border: 1px solid #555; padding: 2px 8px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="header_row">
        <div>
            <h2 class="mb-0">ðŸ›¸ Galactic Host Monitor <small style="font-size: 0.5em; color: #6c757d;">v0.0.69</small></h2>
            <div class="subtitle">
                <span>Source-of-Truth Audit: </span>
                <select id="file-select" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                    <option value="" disabled selected>Loading files...</option>
                </select>
                <span id="filename-container" style="display:none;"></span>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span id="scan-status" class="status-msg"></span>
            <button id="rescanBtn" class="btn btn-galactic btn-sm">Rescan Source-of-Truth</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">
            <div class="card-custom h-100 d-flex flex-column justify-content-center">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-total">0</div>
                    <div class="kpi-label">Total Assets</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-online" style="color: #198754;">0</div>
                    <div class="kpi-label">Systems Online</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-compliance" style="color: #dc3545;">0</div>
                    <div class="kpi-label">Missing EDR</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card-custom h-100">
                <div class="chart-title">Asset Ownership</div>
                <div class="chart-container">
                    <canvas id="ownerChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card-custom h-100">
                <div class="chart-title">EDR Versions</div>
                <div class="chart-container">
                    <canvas id="edrChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card-custom h-100">
                <div class="chart-title">OS Distribution</div>
                <div class="chart-container">
                    <canvas id="osChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card-custom">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <div>
                 <small id="last-updated" class="me-2">Last Scan: Never</small>
                 <button id="boneyardBtn" class="btn btn-secondary btn-sm" style="font-size: 0.8rem; padding: 2px 8px;">Boneyard</button>
            </div>
        </div>
        <table id="hostTable" class="table table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Hostname</th>
                    <th>IP Address</th>
                    <th>OS</th>
                    <th>EDR Ver</th>
                    <th>Owner</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    let ownerChartInstance = null;
    let edrChartInstance = null;
    let osChartInstance = null;
    
    $(document).ready(function () {
        
        // Load initial file list
        fetch('api/files')
            .then(r => r.json())
            .then(files => {
                const select = $('#file-select');
                select.empty();
                files.forEach(f => {
                    select.append(`<option value="${f.id}">${f.name}</option>`);
                });
                select.append('<option value="ADD_NEW" style="font-style:italic; color: #0dcaf0;">+ Add new File ID...</option>');
            });

        // Handle File Selection and Add New
        $('#file-select').change(function() {
            let val = $(this).val();
            
            if(val === 'ADD_NEW') {
                const newId = prompt("Enter the Box File ID for the new spreadsheet:");
                if(!newId || newId.trim() === "") {
                    $(this).val(""); // Reset
                    return;
                }
                val = newId.trim();
            }
            
            if(confirm(`Switch to file ID ${val} and start a new scan?`)) {
                $('#rescanBtn').prop('disabled', true).text('Switching & Scanning...');
                fetch('/rescan?file_id=' + val)
                    .then(r => r.json())
                    .then(d => {
                        checkUpdateLoop($('#rescanBtn'));
                    });
            }
        });

        var table = $('#hostTable').DataTable({
            ajax: {
                url: 'api',
                dataSrc: function(json) {
                    if(json.last_updated) $('#last-updated').text('Last Scan: ' + json.last_updated);
                    if(json.file_id) $('#file-select').val(json.file_id);
                    if(json.hosts) updateDashboard(json.hosts);
                    return json.hosts;
                }
            },
            columns: [
                { data: 'id' },
                { data: 'hostname' },
                { data: 'ip' },
                { data: 'os', defaultContent: "Unknown" },
                { data: 'edr', defaultContent: "Unknown" },
                { data: 'owner', defaultContent: "Unknown" },
                { 
                    data: 'status',
                    render: function(data, type, row) {
                        const ipVal = (row.ip || "").toString().toLowerCase();
                        const edrVal = (row.edr || "").toString().toLowerCase();
                        if (ipVal.includes('boneyard') || edrVal.includes('boneyard')) {
                            return '<span class="badge-boneyard">BONEYARD</span>';
                        }
                        return data === 'online' ? '<span class="badge-online">Online</span>' : '<span class="badge-offline">OFFLINE</span>';
                    }
                }
            ],
            pageLength: 25,
            order: [[6, 'asc']]
        });

        function updateDashboard(hosts) {
            const total = hosts.length;
            const online = hosts.filter(h => h.status === 'online').length;
            const missingEDR = hosts.filter(h => h.edr === 'Unknown' || h.edr === '#N/A').length;

            $('#kpi-total').text(total);
            $('#kpi-online').text(online);
            $('#kpi-compliance').text(missingEDR);

            const aggregate = (field) => {
                const counts = {};
                hosts.forEach(h => {
                    let val = h[field] || "Unknown";
                    if(val === '#N/A' || val === 'nan') val = "Unknown";
                    counts[val] = (counts[val] || 0) + 1;
                });
                return counts;
            };

            const ownerCounts = aggregate('owner');
            const edrCounts = aggregate('edr');
            const osCounts = aggregate('os');

            renderChart('ownerChart', 'pie', ownerCounts, ownerChartInstance, (i) => ownerChartInstance = i, 'owner', hosts);
            renderChart('edrChart', 'doughnut', edrCounts, edrChartInstance, (i) => edrChartInstance = i, 'edr', hosts);
            renderOSChart(osCounts, hosts);
        }

        function renderChart(canvasId, type, dataObj, instance, setInstance, field, hosts) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(instance) instance.destroy();
            const keys = Object.keys(dataObj);
            const values = Object.values(dataObj);
            const colors = generateColors(keys.length);

            const newInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: keys,
                    datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#ccc', boxWidth: 12, padding: 10 } } }
                }
            });
            setInstance(newInstance);
        }

        function renderOSChart(osCounts, hosts) {
            const ctxOS = document.getElementById('osChart').getContext('2d');
            if(osChartInstance) osChartInstance.destroy();
            osChartInstance = new Chart(ctxOS, {
                type: 'bar',
                data: {
                    labels: Object.keys(osCounts),
                    datasets: [{ label: 'Systems', data: Object.values(osCounts), backgroundColor: '#0d6efd', borderRadius: 4 }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#444' }, ticks: { color: '#ccc' } },
                        y: { grid: { display: false }, ticks: { color: '#ccc' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function generateColors(count) {
            const colors = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'];
            return Array.from({length: count}, (_, i) => colors[i % colors.length]);
        }

        $('#rescanBtn').click(function() {
            var btn = $(this);
            btn.prop('disabled', true).text('Scanning...');
            const fileId = $('#file-select').val();
            fetch('rescan?file_id=' + fileId).then(r => r.json()).then(d => checkUpdateLoop(btn));
        });

        function checkUpdateLoop(btn) {
            var checks = 0;
            var interval = setInterval(function() {
                table.ajax.reload(null, false);
                checks++;
                if (checks > 10) { clearInterval(interval); btn.prop('disabled', false).text('Rescan Source-of-Truth'); }
            }, 3000);
        }
    });
</script>
</body>
</html>