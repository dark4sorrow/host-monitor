<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Host Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        .container-fluid { max-width: 98%; }
        .card-custom { background: #2d2d2d; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 20px; padding: 20px; }
        .chart-wrapper { position: relative; height: 250px; width: 100%; }
        .kpi-card { text-align: center; padding: 12px; border-radius: 8px; background: #333; border: 1px solid #444; margin-bottom: 10px; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; color: #fff; }
        .kpi-label { font-size: 0.8rem; color: #ccc; text-transform: uppercase; letter-spacing: 1px; }
        .chart-title { color: #e0e0e0; text-align: center; margin-bottom: 15px; font-weight: 600; font-size: 1.1rem; }
        #last-updated { color: #e0e0e0; opacity: 0.8; font-size: 0.9rem; }
        table.dataTable tbody tr { background-color: #2d2d2d; color: #e0e0e0; }
        .table { color: #e0e0e0; border-color: #404040; }
        .badge-online { background-color: #198754; color: white; padding: 5px 10px; border-radius: 4px; }
        .badge-offline { background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; }
        .badge-boneyard { background-color: #6c757d; color: white; padding: 5px 10px; border-radius: 4px; }
        .header_row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-galactic { background-color: #0d6efd; border: none; color: white; font-weight: 500; transition: all 0.3s; }
        .btn-galactic:hover { background-color: #0b5ed7; box-shadow: 0 0 10px rgba(13, 110, 253, 0.5); }
        .subtitle { color: #b0b0b0; font-size: 0.95rem; margin-top: 4px; display: flex; align-items: center; gap: 8px; }
        #file-select { background-color: #333; color: #e0e0e0; border: 1px solid #555; padding: 2px 8px; font-size: 0.9em; cursor: pointer; }
        .open-link { color: #0dcaf0; font-size: 0.8rem; text-decoration: none; margin-left: 10px; border: 1px solid #444; padding: 2px 8px; border-radius: 4px; }
        .open-link:hover { background: #333; text-decoration: underline; }
        #error-alert { display: none; margin-top: 10px; }

        /* DataTables Dark Mode Overrides */
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            color: #e0e0e0 !important;
        }
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background-color: #333; 
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #e0e0e0 !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            color: #777 !important;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="header_row">
        <div>
            <h2 class="mb-0">ðŸ›¸ Galactic Host Monitor <small style="font-size: 0.5em; color: #6c757d;">v0.0.84</small></h2>
            <div class="subtitle">
                <span>Audit: </span>
                <select id="file-select" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                    <option value="2026233839344">Nov 2025 Audit</option>
                    <option value="1938345796772">Aug 2025 Audit</option>
                </select>
                <a id="open-link" href="#" target="_blank" class="open-link">Open Source File</a>
            </div>
            <div id="error-alert" class="alert alert-danger py-1 px-3 mt-2" style="font-size: 0.85rem;"></div>
        </div>
        <div class="d-flex gap-2">
            <button id="authBtn" class="btn btn-outline-info btn-sm">Service Account Email</button>
            <button id="rescanBtn" class="btn btn-galactic btn-sm">Rescan Source-of-Truth</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">
            <div class="card-custom h-100 d-flex flex-column justify-content-center">
                <div class="kpi-card"><div class="kpi-value" id="kpi-total">0</div><div class="kpi-label">Total Assets</div></div>
                <div class="kpi-card"><div class="kpi-value" id="kpi-online" style="color: #198754;">0</div><div class="kpi-label">Online</div></div>
                <div class="kpi-card"><div class="kpi-value" id="kpi-compliance" style="color: #dc3545;">0</div><div class="kpi-label">Missing EDR</div></div>
            </div>
        </div>
        <div class="col-md-3"><div class="card-custom h-100"><div class="chart-title">Asset Ownership</div><div class="chart-wrapper"><canvas id="ownerChart"></canvas></div></div></div>
        <div class="col-md-3"><div class="card-custom h-100"><div class="chart-title">EDR Versions</div><div class="chart-wrapper"><canvas id="edrChart"></canvas></div></div></div>
        <div class="col-md-4"><div class="card-custom h-100"><div class="chart-title">OS Distribution</div><div class="chart-wrapper"><canvas id="osChart"></canvas></div></div></div>
    </div>

    <div class="card-custom">
        <div class="mb-3">
            <small id="last-updated" class="me-2">Last Scan: Never</small>
            <button id="boneyardBtn" class="btn btn-secondary btn-sm" style="font-size: 0.8rem; padding: 2px 8px;">Boneyard Overlay</button>
        </div>
        <table id="hostTable" class="table table-dark table-hover w-100">
            <thead><tr><th>ID</th><th>Hostname</th><th>IP Address</th><th>OS</th><th>EDR</th><th>Owner</th><th>Status</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content bg-dark text-light border-secondary">
    <div class="modal-header"><h5 class="modal-title" id="detailsModalTitle">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><div style="max-height: 500px; overflow-y: auto;"><table class="table table-dark table-striped" id="detailsTable"><thead><tr><th>Name</th><th>IP Address</th><th>OS</th><th>EDR</th><th>Owner</th></tr></thead><tbody></tbody></table></div></div>
</div></div></div>

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    let currentHosts = [];
    let charts = {};

    function updateDashboard(hosts) {
        $('#kpi-total').text(hosts.length);
        $('#kpi-online').text(hosts.filter(h => h.status === 'online').length);
        $('#kpi-compliance').text(hosts.filter(h => (h.edr || "").toLowerCase() === 'unknown' || (h.edr || "").toLowerCase() === 'nan').length);
        const aggregate = (f) => {
            const counts = {};
            hosts.forEach(h => { let v = h[f] || "Unknown"; if(v.toLowerCase() === 'nan') v = "Unknown"; counts[v] = (counts[v] || 0) + 1; });
            return { labels: Object.keys(counts), data: Object.values(counts) };
        };
        const draw = (id, type, data, field) => {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: type,
                data: { labels: data.labels, datasets: [{ data: data.data, backgroundColor: ['#0d6efd', '#6610f2', '#6f42c1', '#dc3545', '#fd7e14', '#198754'], borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#ccc', boxWidth: 12, padding: 10 } } },
                    onClick: (e, els) => { if(!els.length) return; showDetailsModal(data.labels[els[0].index], field); }
                }
            });
        };
        draw('ownerChart', 'pie', aggregate('owner'), 'owner');
        draw('edrChart', 'doughnut', aggregate('edr'), 'edr');
        draw('osChart', 'bar', aggregate('os'), 'os');
    }

    function showDetailsModal(label, field) {
        const filtered = currentHosts.filter(h => (h[field] || "Unknown") === label);
        $('#detailsModalTitle').text(`${field.toUpperCase()}: ${label} (${filtered.length})`);
        const tbody = $('#detailsTable tbody').empty();
        filtered.forEach(h => tbody.append(`<tr><td>${h.hostname}</td><td>${h.ip}</td><td>${h.os}</td><td>${h.edr}</td><td>${h.owner}</td></tr>`));
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }

    $(document).ready(function() {
        const table = $('#hostTable').DataTable({
            // Explicitly define the DOM layout: 
            // 'f' is filter (search bar), 'l' is length, 't' is table, 'i' is info, 'p' is pagination
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            searching: true, // Ensure searching is enabled
            ajax: { url: 'api', dataSrc: (j) => {
                if(j.error) $('#error-alert').text(j.error).show(); else $('#error-alert').hide();
                $('#last-updated').text("Last Scan: " + (j.last_updated || "Never"));
                $('#open-link').attr('href', 'https://nic.app.box.com/file/' + (j.file_id || '2026233839344'));
                currentHosts = j.hosts || []; updateDashboard(currentHosts); return currentHosts;
            }},
            columns: [
                {data:'id'}, {data:'hostname'}, {data:'ip'}, {data:'os'}, {data:'edr'}, {data:'owner'},
                {data:'status', render: (d,t,r) => {
                    if(((r.ip||"")+(r.edr||"")).toLowerCase().includes('boneyard')) return '<span class="badge-boneyard">BONEYARD</span>';
                    return d === 'online' ? '<span class="badge-online">Online</span>' : '<span class="badge-offline">Offline</span>';
                }}
            ]
        });

        $('#authBtn').click(() => {
            fetch('api/auth_info').then(r => r.json()).then(d => {
                const email = d.email || "Error fetching email";
                navigator.clipboard.writeText(email);
                alert("Service Account Email copied to clipboard:\n\n" + email + "\n\nInvite this address to your Box folder.");
            });
        });

        $('#rescanBtn').click(function() {
            $(this).prop('disabled', true).text('Scanning...');
            $('#error-alert').hide();
            fetch('rescan?file_id=' + $('#file-select').val()).then(() => {
                let attempts = 0;
                let interval = setInterval(() => {
                    table.ajax.reload((json) => {
                        attempts++;
                        if (json.error || attempts > 15) { clearInterval(interval); $('#rescanBtn').prop('disabled', false).text('Rescan Source-of-Truth'); }
                    }, false);
                }, 3000);
            });
        });

        $('#boneyardBtn').click(() => {
            const list = currentHosts.filter(h => ((h.ip||"")+(h.edr||"")).toLowerCase().includes('boneyard'));
            $('#detailsModalTitle').text(`BONEYARD ITEMS (${list.length})`);
            const tbody = $('#detailsTable tbody').empty();
            list.forEach(h => tbody.append(`<tr><td>${h.hostname}</td><td>${h.ip}</td><td>${h.os}</td><td>${h.edr}</td><td>${h.owner}</td></tr>`));
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        });
    });
</script>
</body>
</html>